# Makefile with shared library creation

CC	= gcc
CFLAGS	= -g
TARGET	= math
LIB	= mymath.so
$(TARGET)_SRCS	:= main.c foo.c
lib_SRCS	:= square.c cube.c

#.SECONDEXPANSION:
#%_OBJS		:= $$(patsubst %.c,%.o,$$($$@_SRCS))

# OBJS	= main.o
# LIBOBJS = square.o cube.o foo.o

.SUFFIXES: .c .o

ALL:	$(TARGET)

.SECONDEXPANSION:
$(TARGET): $(LIB) $($(TARGET)_SRCS:.c=.o)
	$(CC) -o $@ $($(TARGET)_SRCS:.c=.o) $(LIB)
	# $(CC) -o $@ $($$@_SRCS:.c=.o) $(LIB)

$(LIB): $(lib_SRCS:.c=.o)
	$(CC) -shared -Wl,-soname,$@ -o $@ $(lib_SRCS:.c=.o)

.c.o:
	@echo $(findstring $<, $(lib_SRCS))
ifneq	(1,$(strip $(findstring $<, $(lib_SRCS))))
	$(CC) -fpic $(CFLAGS) -c $<
else
	$(CC) $(CFLAGS) -c $<
endif

.PHONY: clean

clean:
	/bin/rm -f *.o $(TARGET)
